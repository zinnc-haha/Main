local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Stats = game:GetService("Stats")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local usernameCached = LocalPlayer.Name
local startTime = os.time()

local requestFunction =
    (syn and syn.request)
    or http_request
    or request
    or (http and http.request)

assert(requestFunction, "HTTP request function not found")

local CONFIG_FOLDER = "Z-Notifier"
local CONFIG_FILE = CONFIG_FOLDER .. "/config.json"

if makefolder and not isfolder(CONFIG_FOLDER) then
    makefolder(CONFIG_FOLDER)
end

local config = {
    linkWebhook = "",
    messageId = ""
}

if isfile and isfile(CONFIG_FILE) then
    local ok, data = pcall(function()
        return HttpService:JSONDecode(readfile(CONFIG_FILE))
    end)
    if ok and type(data) == "table" then
        config.linkWebhook = data.linkWebhook or ""
        config.messageId = data.messageId or ""
    end
end

local function saveConfig()
    if writefile then
        writefile(CONFIG_FILE, HttpService:JSONEncode(config))
    end
end

local function notify()
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "Z-Notifier",
            Text = "Webhook stats successfully updated on Discord",
            Duration = 5
        })
    end)
end

local function formatTime(sec)
    return string.format("%02d:%02d:%02d", sec // 3600, (sec % 3600) // 60, sec % 60)
end

local function box(v)
    return "```\n" .. tostring(v) .. "\n```"
end

local function getPing()
    local p = Stats.Network.ServerStatsItem["Data Ping"]
    return p and math.floor(p:GetValue() + 0.5) .. " ms" or "N/A"
end

local function getMemoryUsage()
    local mem = Stats.PerformanceStats:FindFirstChild("Memory")
    return mem and string.format("%.2f MB", mem:GetValue()) or "N/A"
end

local function getCPUUsage()
    local cpu = Stats.PerformanceStats:FindFirstChild("CPU")
    return cpu and string.format("%.2f ms", cpu:GetValue()) or "N/A"
end

local function getExecutor()
    return identifyexecutor and identifyexecutor() or "Unknown"
end

local quotes = {
    "Stay consistent, progress will follow.",
    "Small steps today lead to big results tomorrow.",
    "Focus on improvement, not perfection.",
    "Discipline beats motivation every time.",
    "Every moment is a chance to move forward.",
    "Hard work turns goals into reality.",
    "Keep going, even when it feels slow.",
    "Success is built one decision at a time.",
    "Your effort today defines your outcome.",
    "Progress is progress, no matter how small.",
    "Trust the process and stay committed.",
    "Challenges are part of growth.",
    "Stay focused, stay driven.",
    "Consistency creates unstoppable momentum.",
    "Do something today your future self will thank you for.",
    "Results come from persistence.",
    "Stay patient and keep pushing forward.",
    "Every step forward counts.",
    "Growth begins outside your comfort zone.",
    "Strong habits build strong results.",
    "Pressure creates strength.",
    "Winners are built through consistency.",
    "Execution matters more than intention.",
    "Keep building, even in silence."
}

local function getRandomQuote()
    return quotes[math.random(#quotes)]
end

local function buildPayload()
    return {
        embeds = {{
            title = "Roblox Stats Updated!",
            description = getRandomQuote(),
            color = 0x00B0FF,
            fields = {
                { name = "Username", value = box(usernameCached), inline = false },
                { name = "Uptime", value = box(formatTime(os.time() - startTime)), inline = false },
                { name = "Memory", value = box(getMemoryUsage()), inline = true },
                { name = "CPU", value = box(getCPUUsage()), inline = true },
                { name = "Ping", value = box(getPing()), inline = true },
                { name = "Executor", value = box(getExecutor()), inline = false }
            },
            footer = { text = "Z-Notifier â€¢ Zinnc" },
            timestamp = DateTime.now():ToIsoDate()
        }}
    }
end

local function sendOrEditWebhook()
    if config.linkWebhook == "" then return end

    if config.messageId == "" then
        local res = requestFunction({
            Url = config.linkWebhook .. "?wait=true",
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(buildPayload())
        })

        local data = HttpService:JSONDecode(res.Body)
        if data and data.id then
            config.messageId = data.id
            saveConfig()
            notify()
        end
    else
        requestFunction({
            Url = config.linkWebhook .. "/messages/" .. config.messageId,
            Method = "PATCH",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(buildPayload())
        })

        notify()
    end
end

sendOrEditWebhook()

local UPDATE_INTERVAL = 300
local lastUpdate = os.clock()

RunService.Heartbeat:Connect(function()
    if os.clock() - lastUpdate >= UPDATE_INTERVAL then
        lastUpdate = os.clock()
        sendOrEditWebhook()
    end
end)
