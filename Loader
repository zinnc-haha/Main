local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Stats = game:GetService("Stats")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local usernameCached = LocalPlayer.Name
local startTime = os.time()

local requestFunction =
    (syn and syn.request)
    or http_request
    or request
    or (http and http.request)

if not requestFunction then return end

local CONFIG_FOLDER = "Z-Notifier"
local CONFIG_FILE = CONFIG_FOLDER .. "/config.json"

if makefolder and not isfolder(CONFIG_FOLDER) then
    makefolder(CONFIG_FOLDER)
end

local config = { linkWebhook = "" }

if isfile and isfile(CONFIG_FILE) then
    local ok, data = pcall(function()
        return HttpService:JSONDecode(readfile(CONFIG_FILE))
    end)
    if ok and type(data) == "table" then
        config.linkWebhook = data.linkWebhook or ""
    end
end

local function saveConfig()
    if writefile then
        writefile(CONFIG_FILE, HttpService:JSONEncode(config))
    end
end

local runtimeMessageId = nil

local function notify()
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "Z-Notifier",
            Text = "Webhook stats successfully updated on Discord",
            Duration = 5
        })
    end)
end

if config.linkWebhook == "" then
    local gui = Instance.new("ScreenGui")
    gui.Name = "Z-Notifier"
    gui.Parent = PlayerGui

    local main = Instance.new("Frame", gui)
    main.Size = UDim2.fromScale(0.45, 0.32)
    main.Position = UDim2.fromScale(0.5, 0.5)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    main.BorderSizePixel = 0
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 20)

    local title = Instance.new("TextLabel", main)
    title.Size = UDim2.fromScale(1, 0.25)
    title.BackgroundTransparency = 1
    title.Text = "Z-Notifier"
    title.Font = Enum.Font.GothamBold
    title.TextScaled = true
    title.TextColor3 = Color3.new(1, 1, 1)

    local input = Instance.new("TextBox", main)
    input.Size = UDim2.fromScale(0.9, 0.23)
    input.Position = UDim2.fromScale(0.05, 0.38)
    input.PlaceholderText = "Enter your discord webhook link"
    input.Text = ""
    input.ClearTextOnFocus = false
    input.Font = Enum.Font.Gotham
    input.TextColor3 = Color3.new(1, 1, 1)
    input.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    input.BorderSizePixel = 0
    Instance.new("UICorner", input).CornerRadius = UDim.new(0, 14)

    local button = Instance.new("TextButton", main)
    button.Size = UDim2.fromScale(0.45, 0.22)
    button.Position = UDim2.fromScale(0.275, 0.7)
    button.Text = "ENTER"
    button.Font = Enum.Font.GothamBold
    button.TextScaled = true
    button.TextColor3 = Color3.new(1, 1, 1)
    button.BackgroundColor3 = Color3.fromRGB(60, 130, 255)
    button.BorderSizePixel = 0
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 14)

    button.MouseButton1Click:Connect(function()
        if input.Text ~= "" then
            config.linkWebhook = input.Text
            saveConfig()
            gui:Destroy()
        end
    end)
end

local function formatTime(sec)
    return string.format("%02d:%02d:%02d", sec // 3600, (sec % 3600) // 60, sec % 60)
end

local function box(v)
    return "```\n" .. tostring(v) .. "\n```"
end

local function getPing()
    local p = Stats.Network.ServerStatsItem["Data Ping"]
    return p and math.floor(p:GetValue() + 0.5) .. " ms" or "N/A"
end

local function getMemoryUsage()
    local mem = Stats.PerformanceStats:FindFirstChild("Memory")
    return mem and string.format("%.2f MB", mem:GetValue()) or "N/A"
end

local function getCPUUsage()
    local cpu = Stats.PerformanceStats:FindFirstChild("CPU")
    return cpu and string.format("%.2f ms", cpu:GetValue()) or "N/A"
end

local function getExecutor()
    return identifyexecutor and identifyexecutor() or "Unknown"
end

local quotes = {
    "Stay consistent, progress will follow.",
    "Small steps today lead to big results tomorrow.",
    "Focus on improvement, not perfection.",
    "Discipline beats motivation every time.",
    "Every moment is a chance to move forward.",
    "Hard work turns goals into reality.",
    "Keep going, even when it feels slow.",
    "Success is built one decision at a time.",
    "Your effort today defines your outcome.",
    "Progress is progress, no matter how small.",
    "Trust the process and stay committed.",
    "Challenges are part of growth.",
    "Stay focused, stay driven.",
    "Consistency creates unstoppable momentum.",
    "Do something today your future self will thank you for.",
    "Results come from persistence.",
    "Stay patient and keep pushing forward.",
    "Every step forward counts.",
    "Growth begins outside your comfort zone.",
    "Strong habits build strong results."
}

local function buildPayload()
    return {
        embeds = {{
            title = "Roblox Stats Updated!",
            description = quotes[math.random(#quotes)],
            color = 0x00B0FF,
            fields = {
                { name = "Username", value = box(usernameCached), inline = false },
                { name = "Uptime", value = box(formatTime(os.time() - startTime)), inline = false },
                { name = "Memory", value = box(getMemoryUsage()), inline = true },
                { name = "CPU", value = box(getCPUUsage()), inline = true },
                { name = "Ping", value = box(getPing()), inline = true },
                { name = "Executor", value = box(getExecutor()), inline = false }
            },
            footer = { text = "Z-Notifier â€¢ Zinnc" },
            timestamp = DateTime.now():ToIsoDate()
        }}
    }
end

local function sendOrEditWebhook()
    if config.linkWebhook == "" then return end

    if not runtimeMessageId then
        local ok, res = pcall(function()
            return requestFunction({
                Url = config.linkWebhook .. "?wait=true",
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(buildPayload())
            })
        end)
        if ok and res and res.Body then
            local ok2, data = pcall(function()
                return HttpService:JSONDecode(res.Body)
            end)
            if ok2 and data and data.id then
                runtimeMessageId = data.id
                notify()
            end
        end
    else
        local ok = pcall(function()
            requestFunction({
                Url = config.linkWebhook .. "/messages/" .. runtimeMessageId,
                Method = "PATCH",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(buildPayload())
            })
        end)
        if ok then
            notify()
        else
            runtimeMessageId = nil
        end
    end
end

sendOrEditWebhook()

local UPDATE_INTERVAL = 300
local lastUpdate = os.clock()

RunService.Heartbeat:Connect(function()
    if os.clock() - lastUpdate >= UPDATE_INTERVAL then
        lastUpdate = os.clock()
        sendOrEditWebhook()
    end
end)
